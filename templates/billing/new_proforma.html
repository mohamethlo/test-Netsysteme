{% extends "billing/base.html" %}

{% block billing_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Nouveau Proforma</h1>
</div>

<form method="POST" id="proformaForm">
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="client_id" class="form-label">Client</label>
            <select class="form-select" id="client_id" name="client_id" required>
                <option value="">Sélectionner un client</option>
                {% for client in clients %}
                <option value="{{ client.id }}">{{ client.company_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="proforma_number" class="form-label">Numéro de proforma</label>
            <input type="text" class="form-control" id="proforma_number" name="proforma_number" value="{{ next_number }}" required>
        </div>
        <div class="col-md-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" class="form-control" id="date" name="date" value="{{ today.strftime('%Y-%m-%d') }}" required>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <label for="valid_until" class="form-label">Validité jusqu'au</label>
            <input type="date" class="form-control" id="valid_until" name="valid_until">
        </div>
        <div class="col-md-3">
            <label for="tax_rate" class="form-label">Taux de TVA (%)</label>
            <div class="input-group">
                <input type="number" step="0.01" class="form-control" id="tax_rate" name="tax_rate" value="0">
                <button class="btn btn-outline-secondary" type="button" id="toggleTax">Avec TVA</button>
            </div>
        </div>
        <div class="col-md-3">
            <label for="discount_type" class="form-label">Type de remise</label>
            <select class="form-select" id="discount_type" name="discount_type">
                <option value="none">Aucune remise</option>
                <option value="percent">Pourcentage</option>
                <option value="amount">Montant fixe</option>
            </select>
        </div>
        <div class="col-md-3" id="discount_value_field" style="display: none;">
            <label for="discount_value" class="form-label">Valeur de remise</label>
            <div class="input-group">
                <input type="number" step="0.01" class="form-control" id="discount_value" name="discount_value" value="0">
                <span class="input-group-text" id="discount_suffix">%</span>
            </div>
        </div>
    </div>
    <div class="mb-3">
        <label for="domaine" class="form-label">Domaine</label>
        <select class="form-select" id="domaine" name="domaine" required>
            <option value="">Sélectionner...</option>
            <option value="NETSYSTEME">NETSYSTEME</option>
            <option value="SSE">SSE</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="notes" class="form-label">Notes</label>
        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Articles</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" id="itemsTable">
                    <thead>
                        <tr>
                            <th width="30%">Produit</th>
                            <th width="30%">Description</th>
                            <th width="10%">Qté</th>
                            <th width="15%">Prix Unitaire</th>
                            <th width="10%">Remise %</th>
                            <th width="15%">Total</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-select product-select" name="item_product_id[]">
                                    <option value="">Sélectionner</option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}" 
                                       data-price="{{ product.unit_price }}"
                                       data-description="{{ product.description | replace("`", "'") | replace('"', '&quot;') }}">
                                       {{ product.description | replace("`", "'") }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="text" class="form-control" name="item_description[]" placeholder="Description"></td>
                            <td><input type="number" step="1" class="form-control quantity" name="item_quantity[]" value="1" min="1"></td>
                            <td><input type="number" step="1" class="form-control unit-price" name="item_unit_price[]" value="0" min="0"></td>
                            <td><input type="number" step="1" class="form-control discount" name="item_discount[]" value="0" min="0" max="100"></td>
                            <td class="item-total">0.00 Fcfa</td>
                            <td><button type="button" class="btn btn-danger btn-sm remove-item"><i data-feather="trash-2"></i></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-secondary" id="addItemBtn">
                <i data-feather="plus"></i> Ajouter un article
            </button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                <a href="{{ url_for('billing.manage_proformas') }}" class="btn btn-secondary">
                    <i data-feather="x"></i> Annuler
                </a>
            </div>
        </div>
        <div class="col-md-6">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary">
                    <i data-feather="save"></i> Enregistrer le proforma
                </button>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de la TVA optionnelle
    const toggleTaxBtn = document.getElementById('toggleTax');
    const taxRateInput = document.getElementById('tax_rate');

    toggleTaxBtn.addEventListener('click', function() {
        if (taxRateInput.value === '0') {
            taxRateInput.value = '0.18'; // Valeur par défaut
            this.textContent = 'Sans TVA';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-primary');
        } else {
            taxRateInput.value = '0';
            this.textContent = 'Avec TVA';
            this.classList.remove('btn-primary');
            this.classList.add('btn-outline-secondary');
        }
    });

    // Gestion des remises
    const discountType = document.getElementById('discount_type');
    const discountValueField = document.getElementById('discount_value_field');
    const discountSuffix = document.getElementById('discount_suffix');

    discountType.addEventListener('change', function() {
        if (this.value === 'none') {
            discountValueField.style.display = 'none';
        } else {
            discountValueField.style.display = 'block';
            discountSuffix.textContent = this.value === 'percent' ? '%' : 'Fcfa';
        }
    });

    // Ajout/suppression d'articles
    const addItemBtn = document.getElementById('addItemBtn');
    const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];

    addItemBtn.addEventListener('click', function() {
        const newRow = itemsTable.insertRow();
        newRow.innerHTML = `
            <td>
                <select class="form-select product-select" name="item_product_id[]">
                    <option value="">Sélectionner</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" 
                       data-price="{{ product.unit_price }}"
                       data-description="{{ product.description | replace("`", "'") | replace('"', '&quot;') }}">
                                       {{ product.description | replace("`", "'") }}</option>
                    {% endfor %}
                </select>
            </td>
            <td><input type="text" class="form-control" name="item_description[]" placeholder="Description"></td>
            <td><input type="number" step="0.01" class="form-control quantity" name="item_quantity[]" value="1" min="0.01"></td>
            <td><input type="number" step="0.01" class="form-control unit-price" name="item_unit_price[]" value="0" min="0"></td>
            <td><input type="number" step="0.01" class="form-control discount" name="item_discount[]" value="0" min="0" max="100"></td>
            <td class="item-total">0.00 Fcfa</td>
            <td><button type="button" class="btn btn-danger btn-sm remove-item"><i data-feather="trash-2"></i></button></td>
        `;
        feather.replace();
        initRowEvents(newRow);
    });

    // Initialisation des événements pour la première ligne
    initRowEvents(itemsTable.rows[0]);

    function initRowEvents(row) {
        // Sélection de produit
        const productSelect = row.querySelector('.product-select');
        const unitPriceInput = row.querySelector('.unit-price');
        const descriptionInput = row.querySelector('input[name="item_description[]"]');
        
        productSelect.addEventListener('change', function() {
            if (this.value) {
                const selectedOption = this.options[this.selectedIndex];
                unitPriceInput.value = selectedOption.dataset.price;
                descriptionInput.value = selectedOption.dataset.description || '';
                calculateRowTotal(row);
            }
        });

        // Calcul du total lors de la modification des valeurs
        row.querySelector('.quantity').addEventListener('input', () => calculateRowTotal(row));
        row.querySelector('.unit-price').addEventListener('input', () => calculateRowTotal(row));
        row.querySelector('.discount').addEventListener('input', () => calculateRowTotal(row));

        // Suppression de ligne
        row.querySelector('.remove-item').addEventListener('click', function() {
            if (itemsTable.rows.length > 1) {
                row.remove();
            } else {
                // Réinitialiser la ligne si c'est la dernière
                row.querySelector('.product-select').value = '';
                row.querySelector('input[name="item_description[]"]').value = '';
                row.querySelector('.quantity').value = '1';
                row.querySelector('.unit-price').value = '0';
                row.querySelector('.discount').value = '0';
                row.querySelector('.item-total').textContent = '0.00 Fcfa';
            }
        });
    }

    function calculateRowTotal(row) {
        const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
        const discount = parseFloat(row.querySelector('.discount').value) || 0;
        
        const subtotal = quantity * unitPrice;
        const total = subtotal * (1 - (discount / 100));
        
        row.querySelector('.item-total').textContent = total.toFixed(2) + ' Fcfa';
    }
});
</script>
{% endblock %}