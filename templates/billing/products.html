{% extends "billing/base.html" %}

{% block billing_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Gestion des Produits</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('billing.add_product') }}" class="btn btn-primary">
            <i data-feather="plus"></i> Nouveau produit
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Image</th>
                <th>Désignation</th>
                <th>Stock</th>
                <th>Prix Unitaire</th>
                <th>Fournisseur</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>
                    {% if product.image_path %}
                    <img src="{{ url_for('static', filename=product.image_path) }}" alt="image produit" 
                         style="width: 50px; height: 50px; object-fit: cover;" class="rounded">
                    {% else %}
                    <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                         style="width: 50px; height: 50px;">
                        <i data-feather="package" class="text-muted"></i>
                    </div>
                    {% endif %}
                </td>
                
                <td>{{ product.description|truncate(300) }}</td>
                <td class="{% if product.quantity <= product.alert_quantity %}text-danger fw-bold{% endif %}">
                    {{ product.quantity }}
                    {% if product.quantity <= product.alert_quantity %}
                    <i data-feather="alert-circle" class="text-danger"></i>
                    {% endif %}
                </td>
                <td>{{ "%.2f"|format(product.unit_price) }} Fcfa</td>
                <td>{{ product.supplier|default('-', true) }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary edit-product-btn" 
                            data-product-id="{{ product.id }}">
                        <i data-feather="edit"></i>
                    </button>
                    <form action="{{ url_for('billing.delete_product', product_id=product.id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce produit?')">
                            <i data-feather="trash-2"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Conteneur pour la modale -->
<div id="editModalContainer"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
    
    // Gestion des clics sur le bouton d'édition
    document.querySelectorAll('.edit-product-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            
            fetch(`/billing/products/edit/${productId}/modal`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('editModalContainer').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                    modal.show();
                    feather.replace();
                    
                    // Gestion de la soumission du formulaire
                    document.getElementById('editProductForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        
                        fetch(`/billing/products/edit/${productId}`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            }
                        });
                    });
                });
        });
    });
});
</script>
{% endblock %}