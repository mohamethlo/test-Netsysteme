{% extends "base.html" %}

{% block title %}Modifier utilisateur - {{ super() }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Modifier l'utilisateur</h4>
                </div>
                <form action="{{ url_for('main.edit_user', user_id=user.id) }}" method="POST">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="prenom" class="form-label">Prénom *</label>
                                <input type="text" class="form-control" id="prenom" name="prenom"
                                    value="{{ user.prenom }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="nom" class="form-label">Nom *</label>
                                <input type="text" class="form-control" id="nom" name="nom" value="{{ user.nom }}"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label for="username" class="form-label">Nom d'utilisateur *</label>
                                <input type="text" class="form-control" id="username" name="username"
                                    value="{{ user.username }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email"
                                    value="{{ user.email }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="telephone" class="form-label">Téléphone</label>
                                <input type="tel" class="form-control" id="telephone" name="telephone"
                                    value="{{ user.telephone }}">
                            </div>
                            <div class="col-md-6">
                                <label for="role_id" class="form-label">Rôle *</label>
                                <select class="form-select" id="role_id" name="role_id" required
                                    onchange="updatePermissionsEdit()">
                                    <option value="">Sélectionner un rôle</option>
                                    {% for role in roles %}
                                    <option value="{{ role.id }}" data-permissions="{{ role.permissions }}" {% if
                                        user.role_id==role.id %}selected{% endif %}>{{ role.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 mt-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">Modifier le mot de passe</h5>
                                        <p class="card-text text-muted">Laissez vide pour conserver le mot de passe
                                            actuel</p>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="password" class="form-label">Nouveau mot de passe</label>
                                                <input type="password" class="form-control" id="password"
                                                    name="password" minlength="6">
                                                <div class="form-text">Minimum 6 caractères</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="confirm_password" class="form-label">Confirmer le mot de
                                                    passe</label>
                                                <input type="password" class="form-control" id="confirm_password"
                                                    minlength="6">
                                                <div id="passwordMatch" class="form-text text-danger d-none">
                                                    Les mots de passe ne correspondent pas
                                                </div>
                                            </div>
                                        </div>
                                        <div id="passwordStrength" class="alert mt-3" role="alert"
                                            style="display: none;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Permissions supplémentaires -->
                            <div id="extraPermissions" class="col-12">
                                <label class="form-label">Permissions supplémentaires</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="perm_attendance"
                                        name="permissions" value="attendance" {% if user.permissions and 'attendance' in
                                        user.permissions %}checked{% endif %}>
                                    <label class="form-check-label" for="perm_attendance">Pointage</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="perm_interventions"
                                        name="permissions" value="interventions" {% if user.permissions
                                        and 'interventions' in user.permissions %}checked{% endif %}>
                                    <label class="form-check-label" for="perm_interventions">Interventions</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="perm_inventory"
                                        name="permissions" value="inventory" {% if user.permissions and 'inventory' in
                                        user.permissions %}checked{% endif %}>
                                    <label class="form-check-label" for="perm_inventory">Stock</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="perm_expenses"
                                        name="permissions" value="expenses" {% if user.permissions and 'expenses' in
                                        user.permissions %}checked{% endif %}>
                                    <label class="form-check-label" for="perm_expenses">Dépenses</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="perm_clients" name="permissions"
                                        value="clients" {% if user.permissions and 'clients' in user.permissions
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="perm_clients">Clients</label>
                                </div>
                                <!-- Nouvelles permissions ajoutées -->
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="perm_installations" name="permissions"
                                        value="installations" {% if user.permissions and 'installations' in user.permissions
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="perm_installations">Installations</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="perm_facturation" name="permissions"
                                        value="facturation" {% if user.permissions and 'facturation' in user.permissions
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="perm_facturation">Facturation</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <a href="{{ url_for('main.users') }}" class="btn btn-secondary">Annuler</a>
                        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updatePermissionsEdit() {
        const roleSelect = document.getElementById('role_id');
        const selectedOption = roleSelect.options[roleSelect.selectedIndex];
        const permissions = selectedOption.dataset.permissions;
        const extraPerms = document.getElementById('extraPermissions');
        if (permissions === 'all') {
            extraPerms.style.display = 'none';
        } else {
            extraPerms.style.display = '';
        }
    }
    window.addEventListener('DOMContentLoaded', updatePermissionsEdit);
    document.getElementById('role_id').addEventListener('change', updatePermissionsEdit);
    document.getElementById('confirm_password').addEventListener('input', function () {
        const password = document.getElementById('password').value;
        const confirmation = this.value;
        const matchDisplay = document.getElementById('passwordMatch');
        const submitBtn = document.querySelector('button[type="submit"]');

        if (password && confirmation && password !== confirmation) {
            matchDisplay.classList.remove('d-none');
            submitBtn.disabled = true;
        } else {
            matchDisplay.classList.add('d-none');
            submitBtn.disabled = false;
        }
    });

    // Password strength checker
    document.getElementById('password').addEventListener('input', function () {
        const password = this.value;
        const strengthDisplay = document.getElementById('passwordStrength');

        if (!password) {
            strengthDisplay.style.display = 'none';
            return;
        }

        let strength = 0;
        if (password.length >= 8) strength += 1;
        if (/\d/.test(password)) strength += 1;
        if (/[a-zA-Z]/.test(password)) strength += 1;
        if (/[^A-Za-z0-9]/.test(password)) strength += 1;

        let message = '';
        let className = '';

        switch (strength) {
            case 0:
            case 1:
                message = 'Faible';
                className = 'alert-danger';
                break;
            case 2:
                message = 'Moyen';
                className = 'alert-warning';
                break;
            case 3:
                message = 'Fort';
                className = 'alert-success';
                break;
            case 4:
                message = 'Très fort';
                className = 'alert-success';
                break;
        }

        strengthDisplay.style.display = 'block';
        strengthDisplay.className = 'alert mt-3 ' + className;
        strengthDisplay.textContent = 'Force du mot de passe : ' + message;
    });
</script>
{% endblock %}